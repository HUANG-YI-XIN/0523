<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>BMI èˆ‡è·‘æ­¥æ©Ÿè¨“ç·´è¨ˆç•«ç”¢ç”Ÿå™¨</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f7f7f7; }
        .container { background: #fff; padding: 30px; border-radius: 10px; max-width: 500px; margin: auto; box-shadow: 0 2px 8px #ccc; }
        h1 { text-align: center; }
        label { display: block; margin-top: 15px; }
        input[type="number"], input[type="text"] { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
        button { margin-top: 20px; width: 100%; padding: 10px; background: #0078d7; color: #fff; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        button:hover { background: #005fa3; }
        .result, .plans, .ai-plan { margin-top: 25px; }
        .plan-block { background: #e9f5ff; padding: 15px; border-radius: 7px; margin-bottom: 10px; }
        .ai-plan { background: #fffbe6; padding: 15px; border-radius: 7px; }
    </style>
</head>
<body>
<div class="container">
    <h1>BMI èˆ‡è·‘æ­¥æ©Ÿè¨“ç·´è¨ˆç•«</h1>
    <label>èº«é«˜ (å…¬åˆ†)
        <input type="number" id="height" min="100" max="250" required>
        <button type="button" onclick="startVoice('height')" style="width:auto;padding:5px 10px;margin-left:5px;">ğŸ¤èªéŸ³</button>
    </label>
    <label>é«”é‡ (å…¬æ–¤)
        <input type="number" id="weight" min="30" max="200" required>
        <button type="button" onclick="startVoice('weight')" style="width:auto;padding:5px 10px;margin-left:5px;">ğŸ¤èªéŸ³</button>
    </label>
    <button onclick="calculateBMI()">è¨ˆç®— BMI ä¸¦ç”¢ç”Ÿè¨“ç·´è¨ˆç•«</button>
    <div class="result" id="bmiResult"></div>
    <div class="plans" id="plans"></div>
    <hr>
    <h2>å‚³é€è¨“ç·´æ–¹æ¡ˆåˆ° Arduino Uno</h2>
    <form id="planForm" style="margin-bottom:10px;">
        <label><input type="radio" name="plan" value="A" checked> æ–¹æ¡ˆAï¼ˆåˆéšï¼‰</label>
        <label><input type="radio" name="plan" value="B"> æ–¹æ¡ˆBï¼ˆä¸­éšï¼‰</label>
        <label><input type="radio" name="plan" value="C"> æ–¹æ¡ˆCï¼ˆé«˜éšï¼‰</label>
        <button type="button" onclick="submitPlan()">é€å‡ºé¸å®šæ–¹æ¡ˆåˆ° Arduino</button>
    </form>
    <div id="arduinoStatus" style="color:#0078d7;"></div>
</div>
<script>
// é€å‡ºé¸å®šæ–¹æ¡ˆ
function submitPlan() {
    const plan = document.querySelector('input[name="plan"]:checked').value;
    sendPlanToArduino(plan);
}
// å‚³é€æ–¹æ¡ˆåˆ° Arduino Uno
async function sendPlanToArduino(plan) {
    if (!('serial' in navigator)) {
        alert('è«‹ç”¨æ”¯æ´ Web Serial API çš„ Chrome ç€è¦½å™¨');
        return;
    }
    document.getElementById('arduinoStatus').innerText = 'è«‹é¸æ“‡ Arduino åºåˆ—åŸ ...';
    try {
        const port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        const writer = port.writable.getWriter();
        await writer.write(new TextEncoder().encode(plan));
        writer.releaseLock();
        await port.close();
        document.getElementById('arduinoStatus').innerText = `å·²å‚³é€æ–¹æ¡ˆ${plan}åˆ° Arduinoï¼`;
    } catch (e) {
        document.getElementById('arduinoStatus').innerText = 'å‚³é€å¤±æ•—ï¼Œè«‹ç¢ºèªå·²é€£æ¥ Arduino ä¸¦ä½¿ç”¨ Chromeã€‚';
    }
}
// èªéŸ³è¼¸å…¥åŠŸèƒ½
function startVoice(field) {
    if (!('webkitSpeechRecognition' in window)) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ç”¨ Chrome æ¸¬è©¦');
        return;
    }
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'zh-TW';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onresult = function(event) {
        let result = event.results[0][0].transcript.replace(/[^\d.]/g, '');
        if (result) {
            document.getElementById(field).value = result;
        } else {
            alert('æœªè¾¨è­˜åˆ°æ•¸å­—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
        }
    };
    recognition.onerror = function(event) {
        alert('èªéŸ³è¾¨è­˜éŒ¯èª¤: ' + event.error);
    };
    recognition.start();
}
function calculateBMI() {
    const h = parseFloat(document.getElementById('height').value);
    const w = parseFloat(document.getElementById('weight').value);
    if (!h || !w) {
        document.getElementById('bmiResult').innerHTML = '<span style="color:red">è«‹è¼¸å…¥æ­£ç¢ºçš„èº«é«˜èˆ‡é«”é‡</span>';
        document.getElementById('plans').innerHTML = '';
        return;
    }
    const bmi = w / Math.pow(h/100, 2);
    let status = '';
    let plans = [];
    // ç´°åˆ†é€Ÿåº¦ã€å¡åº¦ã€æ™‚é–“
    // èº«é«˜>180cmé€Ÿåº¦+0.5ï¼Œ<160cmé€Ÿåº¦-0.5
    // é«”é‡>90kgåˆéšæ™‚é–“-5åˆ†ï¼Œ<60kgåˆéšæ™‚é–“+5åˆ†
    let speedAdj = 0;
    if (h > 180) speedAdj = 0.5;
    else if (h < 160) speedAdj = -0.5;
    let timeAdj = 0;
    if (w > 90) timeAdj = -5;
    else if (w < 60) timeAdj = 5;
    function s(base) { return (parseFloat(base) + speedAdj).toFixed(1); }
    function t(base) { return base + timeAdj; }
    if (bmi < 18.5) {
        status = 'é«”é‡éè¼•';
        plans = [
            { level: 'åˆéš', speed: `${s(4)}~${s(5)} km/h`, incline: '0~1%', desc: `ä»¥å¹³åœ°å¿«èµ°ç‚ºä¸»ï¼Œé¿å…åŠ‡çƒˆé‹å‹•ï¼Œå»ºè­°æ¯æ¬¡ ${t(15)}~${t(20)} åˆ†é˜ã€‚` },
            { level: 'ä¸­éš', speed: `${s(5.5)}~${s(6.5)} km/h`, incline: '1~2%', desc: `å¯å˜—è©¦æ…¢è·‘ï¼Œé‡é»åœ¨æ–¼æå‡é«”åŠ›ï¼Œå»ºè­°æ¯æ¬¡ ${t(20)}~${t(30)} åˆ†é˜ã€‚` },
            { level: 'é«˜éš', speed: `${s(7)}~${s(8)} km/h`, incline: '2~3%', desc: `æœ‰é‹å‹•ç¿’æ…£è€…å¯å˜—è©¦çŸ­æ™‚é–“é–“æ­‡è·‘ï¼Œå»ºè­°æ¯æ¬¡ ${t(20)}~${t(30)} åˆ†é˜ã€‚` }
        ];
    } else if (bmi < 24) {
        status = 'æ­£å¸¸';
        plans = [
            { level: 'åˆéš', speed: `${s(5)}~${s(6)} km/h`, incline: '1~2%', desc: `å¿«èµ°æˆ–æ…¢è·‘ï¼Œå»ºç«‹é‹å‹•ç¿’æ…£ï¼Œå»ºè­°æ¯æ¬¡ ${t(20)}~${t(30)} åˆ†é˜ã€‚` },
            { level: 'ä¸­éš', speed: `${s(7)}~${s(8.5)} km/h`, incline: '2~4%', desc: `é–“æ­‡è·‘æ­¥ï¼Œæå‡å¿ƒè‚ºåŠŸèƒ½ï¼Œå»ºè­°æ¯æ¬¡ ${t(30)}~${t(40)} åˆ†é˜ã€‚` },
            { level: 'é«˜éš', speed: `${s(9)}~${s(12)} km/h`, incline: '4~6%', desc: `é«˜å¼·åº¦é–“æ­‡æˆ–å¡åº¦è¨“ç·´ï¼Œå»ºè­°æ¯æ¬¡ ${t(40)} åˆ†é˜ä»¥ä¸Šã€‚` }
        ];
    } else if (bmi < 27) {
        status = 'éé‡';
        plans = [
            { level: 'åˆéš', speed: `${s(4.5)}~${s(5.5)} km/h`, incline: '0~1%', desc: `ä»¥å¹³åœ°å¿«èµ°ç‚ºä¸»ï¼Œæ¸›å°‘è†è“‹è² æ“”ï¼Œå»ºè­°æ¯æ¬¡ ${t(20)}~${t(30)} åˆ†é˜ã€‚` },
            { level: 'ä¸­éš', speed: `${s(6)}~${s(7)} km/h`, incline: '1~2%', desc: `å¿«èµ°èˆ‡æ…¢è·‘äº¤æ›¿ï¼Œå»ºè­°æ¯æ¬¡ ${t(25)}~${t(35)} åˆ†é˜ã€‚` },
            { level: 'é«˜éš', speed: `${s(7.5)}~${s(9)} km/h`, incline: '2~3%', desc: `çŸ­æ™‚é–“æ…¢è·‘èˆ‡å¡åº¦å¿«èµ°é–“æ­‡ï¼Œå»ºè­°æ¯æ¬¡ ${t(30)}~${t(40)} åˆ†é˜ã€‚` }
        ];
    } else {
        status = 'è‚¥èƒ–';
        plans = [
            { level: 'åˆéš', speed: `${s(4)}~${s(5)} km/h`, incline: '0%', desc: `å¹³åœ°æ…¢èµ°ï¼Œé‡é»åœ¨æ–¼å®‰å…¨ï¼Œå»ºè­°æ¯æ¬¡ ${t(10)}~${t(20)} åˆ†é˜ã€‚` },
            { level: 'ä¸­éš', speed: `${s(5)}~${s(6)} km/h`, incline: '0~1%', desc: `å¿«èµ°ç‚ºä¸»ï¼Œé¿å…è·‘æ­¥ï¼Œå»ºè­°æ¯æ¬¡ ${t(20)}~${t(30)} åˆ†é˜ã€‚` },
            { level: 'é«˜éš', speed: `${s(6)}~${s(7)} km/h`, incline: '1~2%', desc: `å¿«èµ°èˆ‡çŸ­æ™‚é–“æ…¢è·‘äº¤æ›¿ï¼Œå»ºè­°æ¯æ¬¡ ${t(20)}~${t(30)} åˆ†é˜ã€‚` }
        ];
    }
    document.getElementById('bmiResult').innerHTML = `ä½ çš„ BMIï¼š<b>${bmi.toFixed(1)}</b>ï¼ˆ${status}ï¼‰`;
    let html = '';
    plans.forEach(p => {
        html += `<div class="plan-block"><b>${p.level}</b><br>é€Ÿåº¦ï¼š${p.speed}<br>å¡åº¦ï¼š${p.incline}<br>${p.desc}</div>`;
    });
    document.getElementById('plans').innerHTML = html;
}

async function generateAIPlan() {
    const h = document.getElementById('height').value;
    const w = document.getElementById('weight').value;
    // å°‡ä½ çš„ Gemini API Key å¯«åœ¨é€™è£¡
    const apiKey = 'AIzaSyD-oI5kU6_DLS0lm9si55T1QIwiArLa1JQ'; // <--- è«‹æ”¹æˆä½ çš„é‡‘é‘°
    if (!h || !w) {
        document.getElementById('aiPlan').innerHTML = '<span style="color:red">è«‹å…ˆè¼¸å…¥èº«é«˜ã€é«”é‡</span>';
        return;
    }
    document.getElementById('aiPlan').innerHTML = 'AI ç”¢ç”Ÿä¸­...';
    const prompt = `è«‹æ ¹æ“šèº«é«˜${h}å…¬åˆ†ã€é«”é‡${w}å…¬æ–¤ï¼Œç”¢ç”Ÿä¸‰ç¨®ä¸åŒå¼·åº¦çš„è·‘æ­¥æ©Ÿè¨“ç·´è¨ˆç•«ï¼ˆåŒ…å«é€Ÿåº¦ã€å¡åº¦ã€æ™‚é–“ï¼‰ï¼Œä¸¦ç°¡è¦èªªæ˜æ¯ç¨®å¼·åº¦é©åˆçš„äººã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚`;
    try {
        const res = await fetch('http://localhost:3000/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiKey, prompt })
        });
        const data = await res.json();
        if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
            document.getElementById('aiPlan').innerHTML = data.candidates[0].content.parts.map(p => p.text).join('<br>');
        } else {
            document.getElementById('aiPlan').innerHTML = '<span style="color:red">AI å›æ‡‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¨å¾Œå†è©¦</span>';
        }
    } catch (e) {
        document.getElementById('aiPlan').innerHTML = '<span style="color:red">AI è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Key</span>';
    }
}
</script>

</body>
</html>
